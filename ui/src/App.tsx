import { Action, ErrorComponent, IResourceItem, Refine } from '@refinedev/core'
import { RefineKbar, RefineKbarProvider } from '@refinedev/kbar'
import routerBindings, { DocumentTitleHandler, NavigateToResource, UnsavedChangesNotifier } from '@refinedev/react-router-v6'
import dataProvider from '@refinedev/simple-rest'
import { BarChart, Calendar, CirclePlay, CloudLightning, Code, Download, Play, TvMinimalPlay, Zap } from 'lucide-react'
import { BrowserRouter, Outlet, Route, Routes } from 'react-router-dom'
import restProvider from './lib/RestProvider'

import './App.css'
import { Layout, MenuItemProps } from './components/layout'
import { Analytics } from './pages/analytics'
import { AnimationCreate, AnimationEdit, AnimationList } from './pages/animation'
import { EventCalendar } from './pages/event-calendar'
import { HLSDownloader } from './pages/hls-downloader'
import { StreamList } from './pages/stream/list'
import { VideoPlayer } from './pages/video-player'
import WeatherForecast from './pages/weather-forecast'

const API_URL = 'http://localhost:3000/api/v1'
const STREAM_API_URL = 'http://localhost:3000/api/v8'

const customTitleHandler = ({
	resource,
	action,
	params,
	pathname,
	autoGeneratedTitle
}: {
	resource?: IResourceItem
	action?: Action
	params?: Record<string, string | undefined>
	pathname?: string
	autoGeneratedTitle: string
}) => {
	return autoGeneratedTitle.replace('| Refine', '| 火拳')
}

function App() {
	const menuItems: MenuItemProps[] = [
		{
			icon: Calendar,
			label: '项目日历',
			path: '/calendar'
		},
		{
			icon: Code,
			label: '代码库',
			children: [
				{
					icon: Play,
					label: '运行代码',
					path: '/run-code'
				},
				{
					icon: Download,
					label: '下载源码',
					path: '/download-code'
				}
			]
		},
		{
			icon: BarChart,
			label: '数据分析',
			path: '/analytics'
		},
		{
			icon: CloudLightning,
			label: '天气预报',
			path: '/weather'
		},
		{
			icon: TvMinimalPlay,
			label: '动画',
			path: '/animation'
		},
		{
			icon: Zap,
			label: '直播流',
			path: '/stream'
		},
		{
			icon: Download,
			label: '下载器',
			path: '/downloader'
		},
		{
			icon: CirclePlay,
			label: '播放器',
			path: '/player'
		}
	]

	return (
		<BrowserRouter>
			<RefineKbarProvider>
				<Refine
					dataProvider={{
						default: dataProvider(API_URL),
						streams: restProvider(STREAM_API_URL)
					}}
					routerProvider={routerBindings}
					resources={[
						{
							name: 'calendar',
							list: '/calendar'
						},
						{
							name: 'animation',
							list: '/animation',
							create: '/animation/create',
							edit: '/animation/edit/:id'
						},
						{
							name: 'stream',
							list: '/stream'
						}
					]}
					options={{
						syncWithLocation: true,
						warnWhenUnsavedChanges: true,
						useNewQueryKeys: true,
						projectId: 'PLCq13-4rLMl1-olLWNJ'
					}}
				>
					<Routes>
						<Route
							element={
								<Layout menuItems={menuItems} title="Lysander">
									<Outlet />
								</Layout>
							}
						>
							<Route index element={<NavigateToResource resource="calendar" />} />
							<Route path="/calendar">
								<Route index element={<EventCalendar />} />
							</Route>

							<Route path="/analytics">
								<Route index element={<Analytics />} />
							</Route>

							<Route path="/weather">
								<Route index element={<WeatherForecast />} />
							</Route>

							<Route path="/animation">
								<Route index element={<AnimationList />} />
								<Route path="create" element={<AnimationCreate />} />
								<Route path="edit/:id" element={<AnimationEdit />} />
							</Route>

							<Route path="/stream">
								<Route index element={<StreamList />} />
							</Route>

							<Route path="*" element={<ErrorComponent />} />
						</Route>

						<Route path="/downloader">
							<Route index element={<HLSDownloader />} />
						</Route>

						<Route path="/player">
							<Route index element={<VideoPlayer />} />
						</Route>
					</Routes>

					<RefineKbar />
					<UnsavedChangesNotifier />
					<DocumentTitleHandler handler={customTitleHandler} />
				</Refine>
			</RefineKbarProvider>
		</BrowserRouter>
	)
}

export default App
